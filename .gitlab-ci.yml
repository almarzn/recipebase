image: node:22

variables:
  # Use NPM's cache directory
  NPM_CONFIG_CACHE: "$CI_PROJECT_DIR/.npm"

cache:
  key:
    files:
      - package-lock.json
  paths:
    - .npm/
    - node_modules/

# Define stages
stages:
  - test
  - prerelease

# Regular build and test job (equivalent to node.js.yml)
build-test:
  stage: test
  script:
    - npm ci
    - npm run build --if-present
    - npm run lint
  variables:
    SUPABASE_ACCESS_TOKEN: $SUPABASE_ACCESS_TOKEN
  rules:
    - if: $CI_COMMIT_BRANCH

# Prerelease job (equivalent to prerelease.yml)
prerelease:
  stage: prerelease
  before_script:
    - npm ci
  script:
    - npx supabase link --project-ref zrthjvdlyijueqygqcmn
    - npx supabase db push
  variables:
    SUPABASE_ACCESS_TOKEN: $SUPABASE_ACCESS_TOKEN
    SUPABASE_DB_PASSWORD: $DB_PASSWORD
    SUPABASE_AUTH_EXTERNAL_GOOGLE_SECRET: $SUPABASE_AUTH_EXTERNAL_GOOGLE_SECRET
  rules:
    - if: $CI_COMMIT_BRANCH =~ /^rc\/.*/
  environment: Staging